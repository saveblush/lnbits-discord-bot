name: publish

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: lnbits-discord-bot
  
jobs:
  push:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      
    - name: Create env file
      run: |
        touch .env
        echo "${{ secrets.ENV_PROD }}" > .env    
    
    - name: Log into registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin
        

    - name: Build Docker image
      run: |
       VERSION=main
       IMAGE_ID=${{ github.repository }}/$IMAGE_NAME
       echo IMAGE_ID=$IMAGE_ID
       echo VERSION=$VERSION
       docker build . --tag ghcr.io/$IMAGE_ID:$VERSION
       docker run ghcr.io/$IMAGE_ID:$VERSION
       docker push ghcr.io/$IMAGE_ID:$VERSION
